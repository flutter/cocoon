// Copyright 2019 The Flutter Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

import 'dart:convert';

import 'package:cocoon_service/cocoon_service.dart';
import 'package:cocoon_service/src/model/luci/pubsub_message_v2.dart';
import 'package:cocoon_service/src/model/luci/user_data.dart';
import 'package:cocoon_service/src/request_handlers/scheduler/scheduler_request_subscription.dart';
import 'package:cocoon_service/src/request_handling/exceptions.dart';
import 'package:fixnum/fixnum.dart';
import 'package:mockito/mockito.dart';
import 'package:retry/retry.dart';
import 'package:test/test.dart';
import 'package:buildbucket/buildbucket_pb.dart' as bbv2;

import '../../src/datastore/fake_config.dart';
import '../../src/request_handling/fake_authentication.dart';
import '../../src/request_handling/fake_http.dart';
import '../../src/request_handling/subscription_v2_tester.dart';
import '../../src/utilities/mocks.dart';

void main() {
  late SchedulerRequestSubscriptionV2 handler;
  late SubscriptionV2Tester tester;

  late MockBuildBucketV2Client buildBucketV2Client;

  setUp(() async {
    buildBucketV2Client = MockBuildBucketV2Client();
    handler = SchedulerRequestSubscriptionV2(
      cache: CacheService(inMemory: true),
      config: FakeConfig(),
      authProvider: FakeAuthenticationProvider(),
      buildBucketClient: buildBucketV2Client,
      retryOptions: const RetryOptions(
        maxAttempts: 3,
        maxDelay: Duration.zero,
      ),
    );

    tester = SubscriptionV2Tester(
      request: FakeHttpRequest(),
    );
  });

  test('throws exception when BatchRequest cannot be decoded', () async {
    tester.message = const PushMessageV2();
    expect(() => tester.post(handler), throwsA(isA<BadRequestException>()));
  });

  test('Push Message v2 decoding', () {
    // we get this after calling utf8 decode and transforming into messagev2
    // object comes in proto 3 form.
    const String message = '''
      {"message":{"data":"eyJyZXF1ZXN0cyI6W3sic2NoZWR1bGVCdWlsZCI6eyJidWlsZGVyIjp7InByb2plY3QiOiJmbHV0dGVyIiwiYnVja2V0IjoidHJ5IiwiYnVpbGRlciI6IkxpbnV4IHdlYl9jYW52YXNraXRfdGVzdHNfNSJ9LCJwcm9wZXJ0aWVzIjp7ImRlcGVuZGVuY2llcyI6W3siZGVwZW5kZW5jeSI6ImN1cmwiLCJ2ZXJzaW9uIjoidmVyc2lvbjo3LjY0LjAifSx7ImRlcGVuZGVuY3kiOiJhbmRyb2lkX3NkayIsInZlcnNpb24iOiJ2ZXJzaW9uOjMzdjYifSx7ImRlcGVuZGVuY3kiOiJjaHJvbWVfYW5kX2RyaXZlciIsInZlcnNpb24iOiJ2ZXJzaW9uOjExOS4wLjYwNDUuOSJ9LHsiZGVwZW5kZW5jeSI6ImdvbGRjdGwiLCJ2ZXJzaW9uIjoiZ2l0X3JldmlzaW9uOjcyMGE1NDJmNmZlNGY5MjkyMmMzYjhmMGZkY2M0ZDJhYzZiYjgzY2QifV0sIm9zIjoiVWJ1bnR1IiwiY29yZXMiOjgsImRldmljZV90eXBlIjoibm9uZSIsInNoYXJkIjoid2ViX2NhbnZhc2tpdF90ZXN0cyIsInN1YnNoYXJkIjo1LCJ0YWdzIjpbImZyYW1ld29yayIsImhvc3Rvbmx5Iiwic2hhcmQiLCJsaW51eCJdLCJwcmVzdWJtaXRfbWF4X2F0dGVtcHRzIjoyLCJicmluZ3VwIjpmYWxzZSwiZ2l0X2JyYW5jaCI6Im1hc3RlciIsImdpdF91cmwiOiJodHRwczovL2dpdGh1Yi5jb20vZmx1dHRlci9mbHV0dGVyIiwiZ2l0X3JlZiI6InJlZnMvcHVsbC8xMzczODgvaGVhZCIsImV4ZV9jaXBkX3ZlcnNpb24iOiJyZWZzL2hlYWRzL21haW4ifSwidGFncyI6W3sia2V5IjoiZ2l0aHViX2NoZWNrcnVuIiwidmFsdWUiOiIxODI4MzE0MDI2OSJ9LHsia2V5IjoiYnVpbGRzZXQiLCJ2YWx1ZSI6InByL2dpdC8xMzczODgifSx7ImtleSI6ImJ1aWxkc2V0IiwidmFsdWUiOiJzaGEvZ2l0LzI1NjkxZjcwMjA3NzEyZTYzNTQyN2U2YmMzYzQ0ZGQ3OWFhYTQzOWUifSx7ImtleSI6InVzZXJfYWdlbnQiLCJ2YWx1ZSI6ImZsdXR0ZXItY29jb29uIn0seyJrZXkiOiJnaXRodWJfbGluayIsInZhbHVlIjoiaHR0cHM6Ly9naXRodWIuY29tL2ZsdXR0ZXIvZmx1dHRlci9wdWxsLzEzNzM4OCJ9LHsia2V5IjoiY2lwZF92ZXJzaW9uIiwidmFsdWUiOiJyZWZzL2hlYWRzL21haW4ifV0sImRpbWVuc2lvbnMiOlt7ImtleSI6Im9zIiwidmFsdWUiOiJVYnVudHUifSx7ImtleSI6ImRldmljZV90eXBlIiwidmFsdWUiOiJub25lIn0seyJrZXkiOiJjb3JlcyIsInZhbHVlIjoiOCJ9XSwibm90aWZ5Ijp7InB1YnN1YlRvcGljIjoicHJvamVjdHMvZmx1dHRlci1kYXNoYm9hcmQvdG9waWNzL2x1Y2ktYnVpbGRzIiwidXNlckRhdGEiOiJaWGxLYVdSWGJITmFSMVo1V0RJMWFHSlhWV2xQYVVwTllWYzFNV1ZEUWpOYVYwcG1XVEpHZFdSdFJucGhNbXd3V0ROU2JHTXpVbnBZZWxWcFRFTkthbUZIVm1waE1UbDVaRmMxWm1GWFVXbFBha1UwVFdwbmVrMVVVWGROYWxrMVRFTkthbUl5TVhSaFdGSm1ZekpvYUVscWIybE5hbFV5VDFSR2JVNTZRWGxOUkdNelRWUktiRTVxVFRGT1JFa3pXbFJhYVZsNlRtcE9SRkpyV2tSak5WbFhSbWhPUkUwMVdsTkpjMGx0VG5aaVZ6RndaRVk1YVdOdFJuVlpNbWRwVDJsS2RGbFlUakJhV0VscFRFTktlVnBZUW5aWU1qa3pZbTFXZVVscWIybGFiWGd4WkVoU2JHTnBTWE5KYmtwc1kwYzVabUp0Um5SYVUwazJTVzFhYzJSWVVqQmFXRWxwVEVOS01XTXlWbmxZTWtadVdsYzFNRWxxYjJsYWJYZ3haRWhTYkdOcE1XcGlNazUyWWpJMGFXWlJQVDA9In0sImZpZWxkcyI6ImlkLGJ1aWxkZXIsbnVtYmVyLHN0YXR1cyx0YWdzIiwiZXhlIjp7ImNpcGRWZXJzaW9uIjoicmVmcy9oZWFkcy9tYWluIn19fSx7InNjaGVkdWxlQnVpbGQiOnsiYnVpbGRlciI6eyJwcm9qZWN0IjoiZmx1dHRlciIsImJ1Y2tldCI6InRyeSIsImJ1aWxkZXIiOiJMaW51eCB3ZWJfY2FudmFza2l0X3Rlc3RzXzYifSwicHJvcGVydGllcyI6eyJkZXBlbmRlbmNpZXMiOlt7ImRlcGVuZGVuY3kiOiJjdXJsIiwidmVyc2lvbiI6InZlcnNpb246Ny42NC4wIn0seyJkZXBlbmRlbmN5IjoiYW5kcm9pZF9zZGsiLCJ2ZXJzaW9uIjoidmVyc2lvbjozM3Y2In0seyJkZXBlbmRlbmN5IjoiY2hyb21lX2FuZF9kcml2ZXIiLCJ2ZXJzaW9uIjoidmVyc2lvbjoxMTkuMC42MDQ1LjkifSx7ImRlcGVuZGVuY3kiOiJnb2xkY3RsIiwidmVyc2lvbiI6ImdpdF9yZXZpc2lvbjo3MjBhNTQyZjZmZTRmOTI5MjJjM2I4ZjBmZGNjNGQyYWM2YmI4M2NkIn1dLCJvcyI6IlVidW50dSIsImNvcmVzIjo4LCJkZXZpY2VfdHlwZSI6Im5vbmUiLCJzaGFyZCI6IndlYl9jYW52YXNraXRfdGVzdHMiLCJzdWJzaGFyZCI6NiwidGFncyI6WyJmcmFtZXdvcmsiLCJob3N0b25seSIsInNoYXJkIiwibGludXgiXSwicHJlc3VibWl0X21heF9hdHRlbXB0cyI6MiwiYnJpbmd1cCI6ZmFsc2UsImdpdF9icmFuY2giOiJtYXN0ZXIiLCJnaXRfdXJsIjoiaHR0cHM6Ly9naXRodWIuY29tL2ZsdXR0ZXIvZmx1dHRlciIsImdpdF9yZWYiOiJyZWZzL3B1bGwvMTM3Mzg4L2hlYWQiLCJleGVfY2lwZF92ZXJzaW9uIjoicmVmcy9oZWFkcy9tYWluIn0sInRhZ3MiOlt7ImtleSI6ImdpdGh1Yl9jaGVja3J1biIsInZhbHVlIjoiMTgyODMxNDAzNzYifSx7ImtleSI6ImJ1aWxkc2V0IiwidmFsdWUiOiJwci9naXQvMTM3Mzg4In0seyJrZXkiOiJidWlsZHNldCIsInZhbHVlIjoic2hhL2dpdC8yNTY5MWY3MDIwNzcxMmU2MzU0MjdlNmJjM2M0NGRkNzlhYWE0MzllIn0seyJrZXkiOiJ1c2VyX2FnZW50IiwidmFsdWUiOiJmbHV0dGVyLWNvY29vbiJ9LHsia2V5IjoiZ2l0aHViX2xpbmsiLCJ2YWx1ZSI6Imh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL2ZsdXR0ZXIvcHVsbC8xMzczODgifSx7ImtleSI6ImNpcGRfdmVyc2lvbiIsInZhbHVlIjoicmVmcy9oZWFkcy9tYWluIn1dLCJkaW1lbnNpb25zIjpbeyJrZXkiOiJvcyIsInZhbHVlIjoiVWJ1bnR1In0seyJrZXkiOiJkZXZpY2VfdHlwZSIsInZhbHVlIjoibm9uZSJ9LHsia2V5IjoiY29yZXMiLCJ2YWx1ZSI6IjgifV0sIm5vdGlmeSI6eyJwdWJzdWJUb3BpYyI6InByb2plY3RzL2ZsdXR0ZXItZGFzaGJvYXJkL3RvcGljcy9sdWNpLWJ1aWxkcyIsInVzZXJEYXRhIjoiWlhsS2FXUlhiSE5hUjFaNVdESTFhR0pYVldsUGFVcE5ZVmMxTVdWRFFqTmFWMHBtV1RKR2RXUnRSbnBoTW13d1dETlNiR016VW5wWWVsbHBURU5LYW1GSFZtcGhNVGw1WkZjMVptRlhVV2xQYWtVMFRXcG5lazFVVVhkTmVtTXlURU5LYW1JeU1YUmhXRkptWXpKb2FFbHFiMmxOYWxVeVQxUkdiVTU2UVhsTlJHTXpUVlJLYkU1cVRURk9SRWt6V2xSYWFWbDZUbXBPUkZKcldrUmpOVmxYUm1oT1JFMDFXbE5KYzBsdFRuWmlWekZ3WkVZNWFXTnRSblZaTW1kcFQybEtkRmxZVGpCYVdFbHBURU5LZVZwWVFuWllNamt6WW0xV2VVbHFiMmxhYlhneFpFaFNiR05wU1hOSmJrcHNZMGM1Wm1KdFJuUmFVMGsyU1cxYWMyUllVakJhV0VscFRFTktNV015Vm5sWU1rWnVXbGMxTUVscWIybGFiWGd4WkVoU2JHTnBNV3BpTWs1MllqSTBhV1pSUFQwPSJ9LCJmaWVsZHMiOiJpZCxidWlsZGVyLG51bWJlcixzdGF0dXMsdGFncyIsImV4ZSI6eyJjaXBkVmVyc2lvbiI6InJlZnMvaGVhZHMvbWFpbiJ9fX0seyJzY2hlZHVsZUJ1aWxkIjp7ImJ1aWxkZXIiOnsicHJvamVjdCI6ImZsdXR0ZXIiLCJidWNrZXQiOiJ0cnkiLCJidWlsZGVyIjoiTGludXggd2ViX2NhbnZhc2tpdF90ZXN0c183X2xhc3QifSwicHJvcGVydGllcyI6eyJkZXBlbmRlbmNpZXMiOlt7ImRlcGVuZGVuY3kiOiJjdXJsIiwidmVyc2lvbiI6InZlcnNpb246Ny42NC4wIn0seyJkZXBlbmRlbmN5IjoiYW5kcm9pZF9zZGsiLCJ2ZXJzaW9uIjoidmVyc2lvbjozM3Y2In0seyJkZXBlbmRlbmN5IjoiY2hyb21lX2FuZF9kcml2ZXIiLCJ2ZXJzaW9uIjoidmVyc2lvbjoxMTkuMC42MDQ1LjkifSx7ImRlcGVuZGVuY3kiOiJnb2xkY3RsIiwidmVyc2lvbiI6ImdpdF9yZXZpc2lvbjo3MjBhNTQyZjZmZTRmOTI5MjJjM2I4ZjBmZGNjNGQyYWM2YmI4M2NkIn1dLCJvcyI6IlVidW50dSIsImNvcmVzIjo4LCJkZXZpY2VfdHlwZSI6Im5vbmUiLCJzaGFyZCI6IndlYl9jYW52YXNraXRfdGVzdHMiLCJzdWJzaGFyZCI6IjdfbGFzdCIsInRhZ3MiOlsiZnJhbWV3b3JrIiwiaG9zdG9ubHkiLCJzaGFyZCIsImxpbnV4Il0sInByZXN1Ym1pdF9tYXhfYXR0ZW1wdHMiOjIsImJyaW5ndXAiOmZhbHNlLCJnaXRfYnJhbmNoIjoibWFzdGVyIiwiZ2l0X3VybCI6Imh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL2ZsdXR0ZXIiLCJnaXRfcmVmIjoicmVmcy9wdWxsLzEzNzM4OC9oZWFkIiwiZXhlX2NpcGRfdmVyc2lvbiI6InJlZnMvaGVhZHMvbWFpbiJ9LCJ0YWdzIjpbeyJrZXkiOiJnaXRodWJfY2hlY2tydW4iLCJ2YWx1ZSI6IjE4MjgzMTQwNDk1In0seyJrZXkiOiJidWlsZHNldCIsInZhbHVlIjoicHIvZ2l0LzEzNzM4OCJ9LHsia2V5IjoiYnVpbGRzZXQiLCJ2YWx1ZSI6InNoYS9naXQvMjU2OTFmNzAyMDc3MTJlNjM1NDI3ZTZiYzNjNDRkZDc5YWFhNDM5ZSJ9LHsia2V5IjoidXNlcl9hZ2VudCIsInZhbHVlIjoiZmx1dHRlci1jb2Nvb24ifSx7ImtleSI6ImdpdGh1Yl9saW5rIiwidmFsdWUiOiJodHRwczovL2dpdGh1Yi5jb20vZmx1dHRlci9mbHV0dGVyL3B1bGwvMTM3Mzg4In0seyJrZXkiOiJjaXBkX3ZlcnNpb24iLCJ2YWx1ZSI6InJlZnMvaGVhZHMvbWFpbiJ9XSwiZGltZW5zaW9ucyI6W3sia2V5Ijoib3MiLCJ2YWx1ZSI6IlVidW50dSJ9LHsia2V5IjoiZGV2aWNlX3R5cGUiLCJ2YWx1ZSI6Im5vbmUifSx7ImtleSI6ImNvcmVzIiwidmFsdWUiOiI4In1dLCJub3RpZnkiOnsicHVic3ViVG9waWMiOiJwcm9qZWN0cy9mbHV0dGVyLWRhc2hib2FyZC90b3BpY3MvbHVjaS1idWlsZHMiLCJ1c2VyRGF0YSI6IlpYbEthV1JYYkhOYVIxWjVXREkxYUdKWFZXbFBhVXBOWVZjMU1XVkRRak5hVjBwbVdUSkdkV1J0Um5waE1td3dXRE5TYkdNelVucFllbVJtWWtkR2VtUkRTWE5KYlU1dldsZE9jbGd6U2pGaWJEbHdXa05KTmsxVVozbFBSRTE0VGtSQk1FOVVWWE5KYlU1MllsY3hjR1JHT1hwaFIwVnBUMmxKZVU1VVdUVk5WMWt6VFVSSmQwNTZZM2hOYlZVeVRYcFZNRTFxWkd4T2JVcHFUVEpOTUU1SFVtdE9lbXhvV1ZkRk1FMTZiR3hKYVhkcFdUSTVkR0pYYkRCWU1rcDVXVmMxYW1GRFNUWkpiVEZvWXpOU2JHTnBTWE5KYmtwc1kwYzVabUl6WkhWYVdFbHBUMmxLYldKSVZqQmtSMVo1U1dsM2FXTnRWbmRpTVRsMVdWY3hiRWxxYjJsYWJYZ3haRWhTYkdOcFNYTkpibFo2V2xoS1psbFhaR3hpYmxGcFQybEtiV0pJVmpCa1IxWjVURmRPZGxreU9YWmlhVW81In0sImZpZWxkcyI6ImlkLGJ1aWxkZXIsbnVtYmVyLHN0YXR1cyx0YWdzIiwiZXhlIjp7ImNpcGRWZXJzaW9uIjoicmVmcy9oZWFkcy9tYWluIn19fSx7InNjaGVkdWxlQnVpbGQiOnsiYnVpbGRlciI6eyJwcm9qZWN0IjoiZmx1dHRlciIsImJ1Y2tldCI6InRyeSIsImJ1aWxkZXIiOiJMaW51eF9hbmRyb2lkIGFuZHJvaWRfZGVmaW5lc190ZXN0In0sInByb3BlcnRpZXMiOnsiZGVwZW5kZW5jaWVzIjpbeyJkZXBlbmRlbmN5IjoiYW5kcm9pZF9zZGsiLCJ2ZXJzaW9uIjoidmVyc2lvbjozM3Y2In0seyJkZXBlbmRlbmN5Ijoib3Blbl9qZGsiLCJ2ZXJzaW9uIjoidmVyc2lvbjoxMSJ9LHsiZGVwZW5kZW5jeSI6ImN1cmwiLCJ2ZXJzaW9uIjoidmVyc2lvbjo3LjY0LjAifSx7ImRlcGVuZGVuY3kiOiJhbmRyb2lkX3ZpcnR1YWxfZGV2aWNlIiwidmVyc2lvbiI6IjM0In1dLCJvcyI6IkxpbnV4IiwiZGV2aWNlX3R5cGUiOiJub25lIiwidGFncyI6WyJkZXZpY2VsYWIiLCJsaW51eCJdLCJ0YXNrX25hbWUiOiJhbmRyb2lkX2RlZmluZXNfdGVzdCIsImJyaW5ndXAiOmZhbHNlLCJnaXRfYnJhbmNoIjoibWFzdGVyIiwiZ2l0X3VybCI6Imh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL2ZsdXR0ZXIiLCJnaXRfcmVmIjoicmVmcy9wdWxsLzEzNzM4OC9oZWFkIiwiZXhlX2NpcGRfdmVyc2lvbiI6InJlZnMvaGVhZHMvbWFpbiJ9LCJ0YWdzIjpbeyJrZXkiOiJnaXRodWJfY2hlY2tydW4iLCJ2YWx1ZSI6IjE4MjgzMTQwNjE2In0seyJrZXkiOiJidWlsZHNldCIsInZhbHVlIjoicHIvZ2l0LzEzNzM4OCJ9LHsia2V5IjoiYnVpbGRzZXQiLCJ2YWx1ZSI6InNoYS9naXQvMjU2OTFmNzAyMDc3MTJlNjM1NDI3ZTZiYzNjNDRkZDc5YWFhNDM5ZSJ9LHsia2V5IjoidXNlcl9hZ2VudCIsInZhbHVlIjoiZmx1dHRlci1jb2Nvb24ifSx7ImtleSI6ImdpdGh1Yl9saW5rIiwidmFsdWUiOiJodHRwczovL2dpdGh1Yi5jb20vZmx1dHRlci9mbHV0dGVyL3B1bGwvMTM3Mzg4In0seyJrZXkiOiJjaXBkX3ZlcnNpb24iLCJ2YWx1ZSI6InJlZnMvaGVhZHMvbWFpbiJ9XSwiZGltZW5zaW9ucyI6W3sia2V5Ijoib3MiLCJ2YWx1ZSI6IkxpbnV4In0seyJrZXkiOiJkZXZpY2VfdHlwZSIsInZhbHVlIjoibm9uZSJ9LHsia2V5Ijoia3ZtIiwidmFsdWUiOiIxIn0seyJrZXkiOiJjb3JlcyIsInZhbHVlIjoiOCJ9LHsia2V5IjoibWFjaGluZV90eXBlIiwidmFsdWUiOiJuMS1zdGFuZGFyZC04In1dLCJub3RpZnkiOnsicHVic3ViVG9waWMiOiJwcm9qZWN0cy9mbHV0dGVyLWRhc2hib2FyZC90b3BpY3MvbHVjaS1idWlsZHMiLCJ1c2VyRGF0YSI6IlpYbEthV1JYYkhOYVIxWjVXREkxYUdKWFZXbFBhVXBOWVZjMU1XVkdPV2hpYlZKNVlqSnNhMGxIUm5WYVNFcDJZVmRTWmxwSFZtMWhWelZzWXpFNU1GcFlUakJKYVhkcFdUSm9iRmt5ZEdaamJsWjFXREpzYTBscWIzaFBSRWswVFhwRk1FMUVXWGhPYVhkcFdUSTVkR0pYYkRCWU0wNXZXVk5KTmtscVNURk9hbXQ0V21wamQwMXFRVE5PZWtWNVdsUlplazVVVVhsT01sVXlXVzFOZWxsNlVUQmFSMUV6VDFkR2FGbFVVWHBQVjFWcFRFTkthbUl5TVhSaFdGSm1XVzVLYUdKdFRtOUphbTlwWWxkR2VtUkhWbmxKYVhkcFkyMVdkMkl4T1haa01qVnNZMmxKTmtsdFduTmtXRkl3V2xoSmFVeERTbmxhV0VKMldESTFhR0pYVldsUGFVcHRZa2hXTUdSSFZubEphWGRwWkZoT2JHTnNPV2hhTWxaMVpFTkpOa2x0V25Oa1dGSXdXbGhKZEZreU9XcGlNamwxU1c0d1BRPT0ifSwiZmllbGRzIjoiaWQsYnVpbGRlcixudW1iZXIsc3RhdHVzLHRhZ3MiLCJleGUiOnsiY2lwZFZlcnNpb24iOiJyZWZzL2hlYWRzL21haW4ifX19LHsic2NoZWR1bGVCdWlsZCI6eyJidWlsZGVyIjp7InByb2plY3QiOiJmbHV0dGVyIiwiYnVja2V0IjoidHJ5IiwiYnVpbGRlciI6Ik1hYyBidWlsZF90ZXN0c18xXzQifSwicHJvcGVydGllcyI6eyJkZXBlbmRlbmNpZXMiOlt7ImRlcGVuZGVuY3kiOiJhcHBsZV9zaWduaW5nIiwidmVyc2lvbiI6InZlcnNpb246dG9fMjAyNCJ9LHsiZGVwZW5kZW5jeSI6ImFuZHJvaWRfc2RrIiwidmVyc2lvbiI6InZlcnNpb246MzN2NiJ9LHsiZGVwZW5kZW5jeSI6ImNocm9tZV9hbmRfZHJpdmVyIiwidmVyc2lvbiI6InZlcnNpb246MTE5LjAuNjA0NS45In0seyJkZXBlbmRlbmN5Ijoib3Blbl9qZGsiLCJ2ZXJzaW9uIjoidmVyc2lvbjoxNyJ9LHsiZGVwZW5kZW5jeSI6InJ1YnkiLCJ2ZXJzaW9uIjoicnVieV8zLjEtcG9kXzEuMTMifSx7ImRlcGVuZGVuY3kiOiJnb2xkY3RsIiwidmVyc2lvbiI6ImdpdF9yZXZpc2lvbjo3MjBhNTQyZjZmZTRmOTI5MjJjM2I4ZjBmZGNjNGQyYWM2YmI4M2NkIn1dLCJvcyI6Ik1hYy0xMnxNYWMtMTMiLCJkZXZpY2VfdHlwZSI6Im5vbmUiLCIkZmx1dHRlci9vc3hfc2RrIjp7InNka192ZXJzaW9uIjoiMTRlMzAwYyJ9LCJhZGRfcmVjaXBlc19jcSI6dHJ1ZSwic2hhcmQiOiJidWlsZF90ZXN0cyIsInN1YnNoYXJkIjoiMV80IiwidGFncyI6WyJmcmFtZXdvcmsiLCJob3N0b25seSIsInNoYXJkIiwibWFjIl0sImJyaW5ndXAiOmZhbHNlLCJnaXRfYnJhbmNoIjoibWFzdGVyIiwiZ2l0X3VybCI6Imh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL2ZsdXR0ZXIiLCJnaXRfcmVmIjoicmVmcy9wdWxsLzEzNzM4OC9oZWFkIiwiZXhlX2NpcGRfdmVyc2lvbiI6InJlZnMvaGVhZHMvbWFpbiJ9LCJ0YWdzIjpbeyJrZXkiOiJnaXRodWJfY2hlY2tydW4iLCJ2YWx1ZSI6IjE4MjgzMTQwNzIxIn0seyJrZXkiOiJidWlsZHNldCIsInZhbHVlIjoicHIvZ2l0LzEzNzM4OCJ9LHsia2V5IjoiYnVpbGRzZXQiLCJ2YWx1ZSI6InNoYS9naXQvMjU2OTFmNzAyMDc3MTJlNjM1NDI3ZTZiYzNjNDRkZDc5YWFhNDM5ZSJ9LHsia2V5IjoidXNlcl9hZ2VudCIsInZhbHVlIjoiZmx1dHRlci1jb2Nvb24ifSx7ImtleSI6ImdpdGh1Yl9saW5rIiwidmFsdWUiOiJodHRwczovL2dpdGh1Yi5jb20vZmx1dHRlci9mbHV0dGVyL3B1bGwvMTM3Mzg4In0seyJrZXkiOiJjaXBkX3ZlcnNpb24iLCJ2YWx1ZSI6InJlZnMvaGVhZHMvbWFpbiJ9XSwiZGltZW5zaW9ucyI6W3sia2V5Ijoib3MiLCJ2YWx1ZSI6Ik1hYy0xMnxNYWMtMTMifSx7ImtleSI6ImRldmljZV90eXBlIiwidmFsdWUiOiJub25lIn1dLCJub3RpZnkiOnsicHVic3ViVG9waWMiOiJwcm9qZWN0cy9mbHV0dGVyLWRhc2hib2FyZC90b3BpY3MvbHVjaS1idWlsZHMiLCJ1c2VyRGF0YSI6IlpYbEthV1JYYkhOYVIxWjVXREkxYUdKWFZXbFBhVXBPV1ZkTloxbHVWbkJpUjFKbVpFZFdlbVJJVG1aTlZqZ3dTV2wzYVZreWFHeFpNblJtWTI1V2RWZ3liR3RKYW05NFQwUkpORTE2UlRCTlJHTjVUVk4zYVZreU9YUmlWMnd3V0ROT2IxbFRTVFpKYWtreFRtcHJlRnBxWTNkTmFrRXpUbnBGZVZwVVdYcE9WRkY1VGpKVk1sbHRUWHBaZWxFd1drZFJNMDlYUm1oWlZGRjZUMWRWYVV4RFNtcGlNakYwWVZoU1psbHVTbWhpYlU1dlNXcHZhV0pYUm5wa1IxWjVTV2wzYVdOdFZuZGlNVGwyWkRJMWJHTnBTVFpKYlZwelpGaFNNRnBZU1dsTVEwcDVXbGhDZGxneU5XaGlWMVZwVDJsS2JXSklWakJrUjFaNVNXbDNhV1JZVG14amJEbG9XakpXZFdSRFNUWkpiVnB6WkZoU01GcFlTWFJaTWpscVlqSTVkVWx1TUQwPSJ9LCJmaWVsZHMiOiJpZCxidWlsZGVyLG51bWJlcixzdGF0dXMsdGFncyIsImV4ZSI6eyJjaXBkVmVyc2lvbiI6InJlZnMvaGVhZHMvbWFpbiJ9fX1dfQ==","messageId":"9540536530549731","publishTime":"2023-11-02T00:17:00.467Z"},"subscription":"projects/flutter-dashboard/subscriptions/scheduler-requests-sub"}
''';

    String message_2 = '''
{"message":{"attributes":{"bucket":"try","builder":"Linux_web web_build_all_packages master","is_completed":"false","project":"flutter","version":"v2"},"data":"ewoJImJ1aWxkUHVic3ViIjogIHsKCQkiYnVpbGQiOiAgewoJCQkiaWQiOiAgIjg3NTI1NzQ5NTY1MDMzODY1NjEiLAoJCQkiYnVpbGRlciI6ICB7CgkJCQkicHJvamVjdCI6ICAiZmx1dHRlciIsCgkJCQkiYnVja2V0IjogICJ0cnkiLAoJCQkJImJ1aWxkZXIiOiAgIkxpbnV4X3dlYiB3ZWJfYnVpbGRfYWxsX3BhY2thZ2VzIG1hc3RlciIKCQkJfSwKCQkJIm51bWJlciI6ICA3NTE2LAoJCQkiY3JlYXRlZEJ5IjogICJ1c2VyOmZsdXR0ZXItZGFzaGJvYXJkQGFwcHNwb3QuZ3NlcnZpY2VhY2NvdW50LmNvbSIsCgkJCSJjcmVhdGVUaW1lIjogICIyMDI0LTAzLTI0VDE0OjM4OjAzLjc3MDUyMDc0M1oiLAoJCQkic3RhcnRUaW1lIjogICIyMDI0LTAzLTI0VDE0OjM4OjA0Ljg2NzA5N1oiLAoJCQkidXBkYXRlVGltZSI6ICAiMjAyNC0wMy0yNFQxNDozODowNC44NjcwOTdaIiwKCQkJInN0YXR1cyI6ICAiU1RBUlRFRCIsCgkJCSJpbnB1dCI6ICB7CgkJCQkiZXhwZXJpbWVudHMiOiAgWwoJCQkJCSJsdWNpLmJ1aWxkYnVja2V0LmFnZW50LmNpcGRfaW5zdGFsbGF0aW9uIiwKCQkJCQkibHVjaS5idWlsZGJ1Y2tldC5hZ2VudC5zdGFydF9idWlsZCIsCgkJCQkJImx1Y2kuYnVpbGRidWNrZXQuYmFja2VuZF9nbyIsCgkJCQkJImx1Y2kuYnVpbGRidWNrZXQuYmJhZ2VudF9nZXRidWlsZCIsCgkJCQkJImx1Y2kuYnVpbGRidWNrZXQuYnFfZXhwb3J0ZXJfZ28iLAoJCQkJCSJsdWNpLmJ1aWxkYnVja2V0LnBhcmVudF90cmFja2luZyIsCgkJCQkJImx1Y2kuYnVpbGRidWNrZXQudXNlX2JiYWdlbnQiLAoJCQkJCSJsdWNpLnJlY2lwZXMudXNlX3B5dGhvbjMiCgkJCQldCgkJCX0sCgkJCSJvdXRwdXQiOiAge30sCgkJCSJpbmZyYSI6ICB7CgkJCQkiYnVpbGRidWNrZXQiOiAgewoJCQkJCSJyZXF1ZXN0ZWRQcm9wZXJ0aWVzIjogIHsKCQkJCQkJImFkZF9yZWNpcGVzX2NxIjogIHRydWUsCgkJCQkJCSJicmluZ3VwIjogIGZhbHNlLAoJCQkJCQkiY2hhbm5lbCI6ICAibWFzdGVyIiwKCQkJCQkJImNvcmVzIjogIDgsCgkJCQkJCSJkZXBlbmRlbmNpZXMiOiAgWwoJCQkJCQkJewoJCQkJCQkJCSJkZXBlbmRlbmN5IjogICJjaHJvbWVfYW5kX2RyaXZlciIsCgkJCQkJCQkJInZlcnNpb24iOiAgInZlcnNpb246MTE0LjAiCgkJCQkJCQl9CgkJCQkJCV0sCgkJCQkJCSJkZXZpY2VfdHlwZSI6ICAibm9uZSIsCgkJCQkJCSJlbnZfdmFyaWFibGVzIjogIHsKCQkJCQkJCSJDSEFOTkVMIjogICJtYXN0ZXIiCgkJCQkJCX0sCgkJCQkJCSJleGVfY2lwZF92ZXJzaW9uIjogICJyZWZzL2hlYWRzL21haW4iLAoJCQkJCQkiZ2l0X2JyYW5jaCI6ICAibWFpbiIsCgkJCQkJCSJnaXRfcmVmIjogICJyZWZzL3B1bGwvNjM3My9oZWFkIiwKCQkJCQkJImdpdF91cmwiOiAgImh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL3BhY2thZ2VzIiwKCQkJCQkJIm9zIjogICJVYnVudHUiLAoJCQkJCQkicmVjaXBlIjogICJwYWNrYWdlcy9wYWNrYWdlcyIsCgkJCQkJCSJ0YXJnZXRfZmlsZSI6ICAid2ViX2J1aWxkX2FsbF9wYWNrYWdlcy55YW1sIiwKCQkJCQkJInZlcnNpb25fZmlsZSI6ICAiZmx1dHRlcl9tYXN0ZXIudmVyc2lvbiIKCQkJCQl9LAoJCQkJCSJyZXF1ZXN0ZWREaW1lbnNpb25zIjogIFsKCQkJCQkJewoJCQkJCQkJImtleSI6ICAib3MiLAoJCQkJCQkJInZhbHVlIjogICJVYnVudHUiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImRldmljZV90eXBlIiwKCQkJCQkJCSJ2YWx1ZSI6ICAibm9uZSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY29yZXMiLAoJCQkJCQkJInZhbHVlIjogICI4IgoJCQkJCQl9CgkJCQkJXSwKCQkJCQkiaG9zdG5hbWUiOiAgImNyLWJ1aWxkYnVja2V0LmFwcHNwb3QuY29tIiwKCQkJCQkiZXhwZXJpbWVudFJlYXNvbnMiOiAgewoJCQkJCQkibHVjaS5iZXN0X2VmZm9ydF9wbGF0Zm9ybSI6ICAiRVhQRVJJTUVOVF9SRUFTT05fR0xPQkFMX0RFRkFVTFQiLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC5hZ2VudC5jaXBkX2luc3RhbGxhdGlvbiI6ICAiRVhQRVJJTUVOVF9SRUFTT05fR0xPQkFMX0RFRkFVTFQiLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC5hZ2VudC5zdGFydF9idWlsZCI6ICAiRVhQRVJJTUVOVF9SRUFTT05fR0xPQkFMX0RFRkFVTFQiLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC5iYWNrZW5kX2FsdCI6ICAiRVhQRVJJTUVOVF9SRUFTT05fR0xPQkFMX0RFRkFVTFQiLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC5iYWNrZW5kX2dvIjogICJFWFBFUklNRU5UX1JFQVNPTl9HTE9CQUxfREVGQVVMVCIsCgkJCQkJCSJsdWNpLmJ1aWxkYnVja2V0LmJiYWdlbnRfZ2V0YnVpbGQiOiAgIkVYUEVSSU1FTlRfUkVBU09OX0dMT0JBTF9ERUZBVUxUIiwKCQkJCQkJImx1Y2kuYnVpbGRidWNrZXQuYnFfZXhwb3J0ZXJfZ28iOiAgIkVYUEVSSU1FTlRfUkVBU09OX0dMT0JBTF9ERUZBVUxUIiwKCQkJCQkJImx1Y2kuYnVpbGRidWNrZXQuY2FuYXJ5X3NvZnR3YXJlIjogICJFWFBFUklNRU5UX1JFQVNPTl9HTE9CQUxfREVGQVVMVCIsCgkJCQkJCSJsdWNpLmJ1aWxkYnVja2V0LnBhcmVudF90cmFja2luZyI6ICAiRVhQRVJJTUVOVF9SRUFTT05fR0xPQkFMX0RFRkFVTFQiLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC51c2VfYmJhZ2VudCI6ICAiRVhQRVJJTUVOVF9SRUFTT05fQlVJTERFUl9DT05GSUciLAoJCQkJCQkibHVjaS5idWlsZGJ1Y2tldC51c2VfYmJhZ2VudF9yYWNlIjogICJFWFBFUklNRU5UX1JFQVNPTl9HTE9CQUxfREVGQVVMVCIsCgkJCQkJCSJsdWNpLm5vbl9wcm9kdWN0aW9uIjogICJFWFBFUklNRU5UX1JFQVNPTl9HTE9CQUxfREVGQVVMVCIsCgkJCQkJCSJsdWNpLnJlY2lwZXMudXNlX3B5dGhvbjMiOiAgIkVYUEVSSU1FTlRfUkVBU09OX0JVSUxERVJfQ09ORklHIgoJCQkJCX0sCgkJCQkJImFnZW50IjogIHsKCQkJCQkJImlucHV0IjogIHsKCQkJCQkJCSJkYXRhIjogIHsKCQkJCQkJCQkiYmJhZ2VudF91dGlsaXR5X3BhY2thZ2VzIjogIHsKCQkJCQkJCQkJImNpcGQiOiAgewoJCQkJCQkJCQkJInNlcnZlciI6ICAiY2hyb21lLWluZnJhLXBhY2thZ2VzLmFwcHNwb3QuY29tIiwKCQkJCQkJCQkJCSJzcGVjcyI6ICBbCgkJCQkJCQkJCQkJewoJCQkJCQkJCQkJCQkicGFja2FnZSI6ICAiaW5mcmEvdG9vbHMvbHVjaS9jYXMvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOjYyM2Y4ZDE3YTA2OWVhZWE2ZDBmY2ExMzE0Nzg4ODI4NGVjNzZmZjEiCgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJXQoJCQkJCQkJCQl9LAoJCQkJCQkJCQkib25QYXRoIjogIFsKCQkJCQkJCQkJCSJiYmFnZW50X3V0aWxpdHlfcGFja2FnZXMiLAoJCQkJCQkJCQkJImJiYWdlbnRfdXRpbGl0eV9wYWNrYWdlcy9iaW4iCgkJCQkJCQkJCV0KCQkJCQkJCQl9LAoJCQkJCQkJCSJjaXBkX2Jpbl9wYWNrYWdlcyI6ICB7CgkJCQkJCQkJCSJjaXBkIjogIHsKCQkJCQkJCQkJCSJzZXJ2ZXIiOiAgImNocm9tZS1pbmZyYS1wYWNrYWdlcy5hcHBzcG90LmNvbSIsCgkJCQkJCQkJCQkic3BlY3MiOiAgWwoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhLzNwcC90b29scy9naXQvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAidmVyc2lvbjoyQDIuNDIuMC5jaHJvbWl1bS4xMSIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL2dpdC8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246ZWM0OTRmMzYzZmRmZDhjZGQ1OTI2YmFhZDQ1MDhkNTYyYjczNTNkNCIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL2x1Y2kvZ2l0LWNyZWRlbnRpYWwtbHVjaS8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246ZWM0OTRmMzYzZmRmZDhjZGQ1OTI2YmFhZDQ1MDhkNTYyYjczNTNkNCIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL2x1Y2kvZG9ja2VyLWNyZWRlbnRpYWwtbHVjaS8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246ZWM0OTRmMzYzZmRmZDhjZGQ1OTI2YmFhZDQ1MDhkNTYyYjczNTNkNCIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL2x1Y2kvdnB5dGhvbjMvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOmFmOTE0MGU2OTE3ZmI5N2JmODA4ZDhhODk2MmRkNGE4OTgwNjU0MzIiCgkJCQkJCQkJCQkJfSwKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJpbmZyYS90b29scy9sdWNpL2x1Y2ljZmcvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOjZhNDY1Njg0MmZiZmYwNjU0Y2I3NDNiNTNhYzk1YTliNTk4NjUwOWYiCgkJCQkJCQkJCQkJfSwKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJpbmZyYS90b29scy9sdWNpLWF1dGgvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOjAyZmZlNmUyYjIyMmFhMWY1Njc3NmI4ZTUzODVmNDk2ODc0NTFiYjIiCgkJCQkJCQkJCQkJfSwKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJpbmZyYS90b29scy9iYi8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246YjFlZjM0ZTNjODYyNjliMTI2MWNjYmMwMzlmZjJjZmUzYmFhYTk2MSIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL2Nsb3VkdGFpbC8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246ZWM0OTRmMzYzZmRmZDhjZGQ1OTI2YmFhZDQ1MDhkNTYyYjczNTNkNCIKCQkJCQkJCQkJCQl9LAoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhL3Rvb2xzL3BycGMvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOmVjNDk0ZjM2M2ZkZmQ4Y2RkNTkyNmJhYWQ0NTA4ZDU2MmI3MzUzZDQiCgkJCQkJCQkJCQkJfSwKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJpbmZyYS90b29scy9yZGIvJHtwbGF0Zm9ybX0iLAoJCQkJCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOmNiY2I2YjlhNzAwOGUzMWQzMzY3NGIxY2UwMDIzZGI1ZDAxOGIxNDkiCgkJCQkJCQkJCQkJfSwKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJpbmZyYS90b29scy9sdWNpL2xlZC8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246MzUzM2NjNjQ5NzM1NTVlMDkyNDk5NjRjNmVmYmQ4YWQ4YTUzZjUzYyIKCQkJCQkJCQkJCQl9CgkJCQkJCQkJCQldCgkJCQkJCQkJCX0sCgkJCQkJCQkJCSJvblBhdGgiOiAgWwoJCQkJCQkJCQkJImNpcGRfYmluX3BhY2thZ2VzIiwKCQkJCQkJCQkJCSJjaXBkX2Jpbl9wYWNrYWdlcy9iaW4iCgkJCQkJCQkJCV0KCQkJCQkJCQl9LAoJCQkJCQkJCSJjaXBkX2Jpbl9wYWNrYWdlcy9jcHl0aG9uMyI6ICB7CgkJCQkJCQkJCSJjaXBkIjogIHsKCQkJCQkJCQkJCSJzZXJ2ZXIiOiAgImNocm9tZS1pbmZyYS1wYWNrYWdlcy5hcHBzcG90LmNvbSIsCgkJCQkJCQkJCQkic3BlY3MiOiAgWwoJCQkJCQkJCQkJCXsKCQkJCQkJCQkJCQkJInBhY2thZ2UiOiAgImluZnJhLzNwcC90b29scy9jcHl0aG9uMy8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJ2ZXJzaW9uOjJAMy44LjEwLmNocm9taXVtLjI2IgoJCQkJCQkJCQkJCX0KCQkJCQkJCQkJCV0KCQkJCQkJCQkJfSwKCQkJCQkJCQkJIm9uUGF0aCI6ICBbCgkJCQkJCQkJCQkiY2lwZF9iaW5fcGFja2FnZXMvY3B5dGhvbjMiLAoJCQkJCQkJCQkJImNpcGRfYmluX3BhY2thZ2VzL2NweXRob24zL2JpbiIKCQkJCQkJCQkJXQoJCQkJCQkJCX0sCgkJCQkJCQkJImtpdGNoZW4tY2hlY2tvdXQiOiAgewoJCQkJCQkJCQkiY2lwZCI6ICB7CgkJCQkJCQkJCQkic2VydmVyIjogICJjaHJvbWUtaW5mcmEtcGFja2FnZXMuYXBwc3BvdC5jb20iLAoJCQkJCQkJCQkJInNwZWNzIjogIFsKCQkJCQkJCQkJCQl7CgkJCQkJCQkJCQkJCSJwYWNrYWdlIjogICJmbHV0dGVyL3JlY2lwZV9idW5kbGVzL2ZsdXR0ZXIuZ29vZ2xlc291cmNlLmNvbS9yZWNpcGVzIiwKCQkJCQkJCQkJCQkJInZlcnNpb24iOiAgInJlZnMvaGVhZHMvbWFpbiIKCQkJCQkJCQkJCQl9CgkJCQkJCQkJCQldCgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQl9LAoJCQkJCQkJImNpcGRTb3VyY2UiOiAgewoJCQkJCQkJCSJjaXBkIjogIHsKCQkJCQkJCQkJImNpcGQiOiAgewoJCQkJCQkJCQkJInNlcnZlciI6ICAiY2hyb21lLWluZnJhLXBhY2thZ2VzLmFwcHNwb3QuY29tIiwKCQkJCQkJCQkJCSJzcGVjcyI6ICBbCgkJCQkJCQkJCQkJewoJCQkJCQkJCQkJCQkicGFja2FnZSI6ICAiaW5mcmEvdG9vbHMvY2lwZC8ke3BsYXRmb3JtfSIsCgkJCQkJCQkJCQkJCSJ2ZXJzaW9uIjogICJnaXRfcmV2aXNpb246MjAwZGJkZjBlOTY3ZTgxMzg4MzU5ZDNmODVmMDk1ZDM5YjM1ZGI2NyIKCQkJCQkJCQkJCQl9CgkJCQkJCQkJCQldCgkJCQkJCQkJCX0sCgkJCQkJCQkJCSJvblBhdGgiOiAgWwoJCQkJCQkJCQkJImNpcGQiLAoJCQkJCQkJCQkJImNpcGQvYmluIgoJCQkJCQkJCQldCgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9LAoJCQkJCQkic291cmNlIjogIHsKCQkJCQkJCSJjaXBkIjogIHsKCQkJCQkJCQkicGFja2FnZSI6ICAiaW5mcmEvdG9vbHMvbHVjaS9iYmFnZW50LyR7cGxhdGZvcm19IiwKCQkJCQkJCQkidmVyc2lvbiI6ICAiZ2l0X3JldmlzaW9uOjFmODAxYzQ4OTRhN2NlZDg1OWFlNjcyNjQyZmVlZWI4OTYwZGEzMzAiLAoJCQkJCQkJCSJzZXJ2ZXIiOiAgImNocm9tZS1pbmZyYS1wYWNrYWdlcy5hcHBzcG90LmNvbSIKCQkJCQkJCX0KCQkJCQkJfSwKCQkJCQkJInB1cnBvc2VzIjogIHsKCQkJCQkJCSJiYmFnZW50X3V0aWxpdHlfcGFja2FnZXMiOiAgIlBVUlBPU0VfQkJBR0VOVF9VVElMSVRZIiwKCQkJCQkJCSJraXRjaGVuLWNoZWNrb3V0IjogICJQVVJQT1NFX0VYRV9QQVlMT0FEIgoJCQkJCQl9LAoJCQkJCQkiY2lwZENsaWVudENhY2hlIjogIHsKCQkJCQkJCSJuYW1lIjogICJjaXBkX2NsaWVudF85NGQwNzUxMTRjY2I2ZDY0YWMwZDM1N2VjYjQwMjg5ZDU0MDUzZDdlMDM2NDRkZDcyOTRmZDI4OTYyOWM2Y2UwIiwKCQkJCQkJCSJwYXRoIjogICJjaXBkX2NsaWVudCIKCQkJCQkJfSwKCQkJCQkJImNpcGRQYWNrYWdlc0NhY2hlIjogIHsKCQkJCQkJCSJuYW1lIjogICJjaXBkX2NhY2hlXzkyMzdhMDgzNjMzMWIwMWE2MWNiN2E1ZWQ1OWM2ZjdiMWZhODViZjdmMTRjYzEzNmJlNGE2MjM3Y2JkNTkwMTEiLAoJCQkJCQkJInBhdGgiOiAgImNpcGRfY2FjaGUiCgkJCQkJCX0KCQkJCQl9LAoJCQkJCSJrbm93blB1YmxpY0dlcnJpdEhvc3RzIjogIFsKCQkJCQkJImFuZHJvaWQuZ29vZ2xlc291cmNlLmNvbSIsCgkJCQkJCSJhb21lZGlhLmdvb2dsZXNvdXJjZS5jb20iLAoJCQkJCQkiYm9yaW5nc3NsLmdvb2dsZXNvdXJjZS5jb20iLAoJCQkJCQkiY2hyb21pdW0uZ29vZ2xlc291cmNlLmNvbSIsCgkJCQkJCSJkYXJ0Lmdvb2dsZXNvdXJjZS5jb20iLAoJCQkJCQkiZGF3bi5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJImZ1Y2hzaWEuZ29vZ2xlc291cmNlLmNvbSIsCgkJCQkJCSJnbi5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJImdvLmdvb2dsZXNvdXJjZS5jb20iLAoJCQkJCQkibGx2bS5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJInBkZml1bS5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJInF1aWNoZS5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJInNraWEuZ29vZ2xlc291cmNlLmNvbSIsCgkJCQkJCSJzd2lmdHNoYWRlci5nb29nbGVzb3VyY2UuY29tIiwKCQkJCQkJIndlYnJ0Yy5nb29nbGVzb3VyY2UuY29tIgoJCQkJCV0sCgkJCQkJImJ1aWxkTnVtYmVyIjogIHRydWUKCQkJCX0sCgkJCQkic3dhcm1pbmciOiAgewoJCQkJCSJob3N0bmFtZSI6ICAiY2hyb21pdW0tc3dhcm0uYXBwc3BvdC5jb20iLAoJCQkJCSJ0YXNrSWQiOiAgIjY4ODliNzM3MWVkODBkMTAiLAoJCQkJCSJ0YXNrU2VydmljZUFjY291bnQiOiAgImZsdXR0ZXItdHJ5LWJ1aWxkZXJAY2hvcHMtc2VydmljZS1hY2NvdW50cy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCgkJCQkJInByaW9yaXR5IjogIDMwLAoJCQkJCSJ0YXNrRGltZW5zaW9ucyI6ICBbCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNvcmVzIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiOCIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiZGV2aWNlX3R5cGUiLAoJCQkJCQkJInZhbHVlIjogICJub25lIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJvcyIsCgkJCQkJCQkidmFsdWUiOiAgIlVidW50dSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAicG9vbCIsCgkJCQkJCQkidmFsdWUiOiAgImx1Y2kuZmx1dHRlci50cnkiCgkJCQkJCX0KCQkJCQldLAoJCQkJCSJib3REaW1lbnNpb25zIjogIFsKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiYm90X2NvbmZpZyIsCgkJCQkJCQkidmFsdWUiOiAgImJvdF9jb25maWcucHkiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNhY2hlcyIsCgkJCQkJCQkidmFsdWUiOiAgImNpcGRfY2FjaGVfOTIzN2EwODM2MzMxYjAxYTYxY2I3YTVlZDU5YzZmN2IxZmE4NWJmN2YxNGNjMTM2YmU0YTYyMzdjYmQ1OTAxMSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY2FjaGVzIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiY2lwZF9jbGllbnRfOTRkMDc1MTE0Y2NiNmQ2NGFjMGQzNTdlY2I0MDI4OWQ1NDA1M2Q3ZTAzNjQ0ZGQ3Mjk0ZmQyODk2MjljNmNlMCIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY2FjaGVzIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiZW5naW5lX21haW5fYnVpbGRlciIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY2FjaGVzIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiZW5naW5lX21haW5fZ2l0IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJjYWNoZXMiLAoJCQkJCQkJInZhbHVlIjogICJwYWNrYWdlc19tYWluX2FuZHJvaWRfc2RrX3ZlcnNpb25fMzN2Nl9sZWdhY3kiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNhY2hlcyIsCgkJCQkJCQkidmFsdWUiOiAgInBhY2thZ2VzX21haW5fY2hyb21lX2FuZF9kcml2ZXJfdmVyc2lvbl8xMTRfMF9sZWdhY3kiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNhY2hlcyIsCgkJCQkJCQkidmFsdWUiOiAgInBhY2thZ2VzX21haW5fb3Blbl9qZGtfdmVyc2lvbl8xN19sZWdhY3kiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNhY2hlcyIsCgkJCQkJCQkidmFsdWUiOiAgInZweXRob24iCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNpcGRfcGxhdGZvcm0iLAoJCQkJCQkJInZhbHVlIjogICJsaW51eC1hbWQ2NCIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY29yZXMiLAoJCQkJCQkJInZhbHVlIjogICI4IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJjcHUiLAoJCQkJCQkJInZhbHVlIjogICJ4ODYiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNwdSIsCgkJCQkJCQkidmFsdWUiOiAgIng4Ni02NCIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAiY3B1IiwKCQkJCQkJCSJ2YWx1ZSI6ICAieDg2LTY0LUJyb2Fkd2VsbF9HQ0UiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImNwdSIsCgkJCQkJCQkidmFsdWUiOiAgIng4Ni02NC1hdngyIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJkZXZpY2Vfb3MiLAoJCQkJCQkJInZhbHVlIjogICJub25lIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJkZXZpY2VfdHlwZSIsCgkJCQkJCQkidmFsdWUiOiAgIm5vbmUiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImRpc3BsYXlfYXR0YWNoZWQiLAoJCQkJCQkJInZhbHVlIjogICIwIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJnY2UiLAoJCQkJCQkJInZhbHVlIjogICIxIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJnY3AiLAoJCQkJCQkJInZhbHVlIjogICJmbHV0dGVyLW1hY2hpbmVzLXByb2QiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImdwdSIsCgkJCQkJCQkidmFsdWUiOiAgIm5vbmUiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImlkIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiZmx1dHRlci10cnktZmx1dHRlcnByai11YnVudHUtdXMtY2VudHJhbDEtYS01OS1mYjduIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJpbWFnZSIsCgkJCQkJCQkidmFsdWUiOiAgImRhcnQtZm9jYWwtMjQwMzE3MDAtODNlZWQ0ZWE2ZDAiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImluc2lkZV9kb2NrZXIiLAoJCQkJCQkJInZhbHVlIjogICIwIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJrZXJuZWwiLAoJCQkJCQkJInZhbHVlIjogICI1LjE1LjAtMTA1My1nY3AiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImt2bSIsCgkJCQkJCQkidmFsdWUiOiAgIjEiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgImxvY2FsZSIsCgkJCQkJCQkidmFsdWUiOiAgImVuX1VTLlVURi04IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJtYWNoaW5lX3R5cGUiLAoJCQkJCQkJInZhbHVlIjogICJuMS1zdGFuZGFyZC04IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJvcyIsCgkJCQkJCQkidmFsdWUiOiAgIkxpbnV4IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJvcyIsCgkJCQkJCQkidmFsdWUiOiAgIlVidW50dSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAib3MiLAoJCQkJCQkJInZhbHVlIjogICJVYnVudHUtMjAiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgIm9zIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiVWJ1bnR1LTIwLjA0IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJvcyIsCgkJCQkJCQkidmFsdWUiOiAgIlVidW50dS0yMC4wNC42IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJwb29sIiwKCQkJCQkJCSJ2YWx1ZSI6ICAibHVjaS5mbHV0dGVyLnRyeSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAicHl0aG9uIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiMyIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJImtleSI6ICAicHl0aG9uIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiMy44IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJweXRob24iLAoJCQkJCQkJInZhbHVlIjogICIzLjguMTArY2hyb21pdW0uMjMiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgInNlcnZlcl92ZXJzaW9uIiwKCQkJCQkJCSJ2YWx1ZSI6ICAiNzU4Ny00NDA4NDkyIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJzc2QiLAoJCQkJCQkJInZhbHVlIjogICIxIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJ6b25lIiwKCQkJCQkJCSJ2YWx1ZSI6ICAidXMiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgInpvbmUiLAoJCQkJCQkJInZhbHVlIjogICJ1cy1jZW50cmFsIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkia2V5IjogICJ6b25lIiwKCQkJCQkJCSJ2YWx1ZSI6ICAidXMtY2VudHJhbDEiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJrZXkiOiAgInpvbmUiLAoJCQkJCQkJInZhbHVlIjogICJ1cy1jZW50cmFsMS1hIgoJCQkJCQl9CgkJCQkJXSwKCQkJCQkiY2FjaGVzIjogIFsKCQkJCQkJewoJCQkJCQkJIm5hbWUiOiAgInB1Yl9jYWNoZSIsCgkJCQkJCQkicGF0aCI6ICAiLnB1Yi1jYWNoZSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJIm5hbWUiOiAgInBhY2thZ2VzX21haW5fYnVpbGRlciIsCgkJCQkJCQkicGF0aCI6ICAiYnVpbGRlciIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJIm5hbWUiOiAgInBhY2thZ2VzX21haW5fY2hyb21lX2FuZF9kcml2ZXJfdmVyc2lvbl8xMTRfMF9sZWdhY3kiLAoJCQkJCQkJInBhdGgiOiAgImNocm9tZSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJIm5hbWUiOiAgInBhY2thZ2VzX21haW5fY2hyb21lX2FuZF9kcml2ZXJfdmVyc2lvbl8xMTRfMCIsCgkJCQkJCQkicGF0aCI6ICAiY2hyb21lX2FuZF9kcml2ZXIiCgkJCQkJCX0sCgkJCQkJCXsKCQkJCQkJCSJuYW1lIjogICJwYWNrYWdlc19tYWluX2dpdCIsCgkJCQkJCQkicGF0aCI6ICAiZ2l0IgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkibmFtZSI6ICAiZ29tYV92MiIsCgkJCQkJCQkicGF0aCI6ICAiZ29tYSIKCQkJCQkJfSwKCQkJCQkJewoJCQkJCQkJIm5hbWUiOiAgImdyYWRsZSIsCgkJCQkJCQkicGF0aCI6ICAiZ3JhZGxlIgoJCQkJCQl9LAoJCQkJCQl7CgkJCQkJCQkibmFtZSI6ICAidnB5dGhvbiIsCgkJCQkJCQkicGF0aCI6ICAidnB5dGhvbiIsCgkJCQkJCQkiZW52VmFyIjogICJWUFlUSE9OX1ZJUlRVQUxFTlZfUk9PVCIKCQkJCQkJfQoJCQkJCV0KCQkJCX0sCgkJCQkibG9nZG9nIjogIHsKCQkJCQkiaG9zdG5hbWUiOiAgImxvZ3MuY2hyb21pdW0ub3JnIiwKCQkJCQkicHJvamVjdCI6ICAiZmx1dHRlciIsCgkJCQkJInByZWZpeCI6ICAiYnVpbGRidWNrZXQvY3ItYnVpbGRidWNrZXQvODc1MjU3NDk1NjUwMzM4NjU2MSIKCQkJCX0sCgkJCQkicmVzdWx0ZGIiOiAgewoJCQkJCSJob3N0bmFtZSI6ICAicmVzdWx0cy5hcGkuY3IuZGV2IgoJCQkJfSwKCQkJCSJiYmFnZW50IjogIHsKCQkJCQkicGF5bG9hZFBhdGgiOiAgImtpdGNoZW4tY2hlY2tvdXQiLAoJCQkJCSJjYWNoZURpciI6ICAiY2FjaGUiCgkJCQl9CgkJCX0sCgkJCSJ0YWdzIjogIFsKCQkJCXsKCQkJCQkia2V5IjogICJidWlsZHNldCIsCgkJCQkJInZhbHVlIjogICJwci9naXQvNjM3MyIKCQkJCX0sCgkJCQl7CgkJCQkJImtleSI6ICAiYnVpbGRzZXQiLAoJCQkJCSJ2YWx1ZSI6ICAic2hhL2dpdC8yNzJjMDY4MzIzNWFjOGM3ZTkzZDEyY2FmM2Y2NGI3ZTVhMGI1YzMyIgoJCQkJfSwKCQkJCXsKCQkJCQkia2V5IjogICJjaXBkX3ZlcnNpb24iLAoJCQkJCSJ2YWx1ZSI6ICAicmVmcy9oZWFkcy9tYWluIgoJCQkJfSwKCQkJCXsKCQkJCQkia2V5IjogICJnaXRodWJfY2hlY2tydW4iLAoJCQkJCSJ2YWx1ZSI6ICAiMjMwMDU3MzMzODQiCgkJCQl9LAoJCQkJewoJCQkJCSJrZXkiOiAgImdpdGh1Yl9saW5rIiwKCQkJCQkidmFsdWUiOiAgImh0dHBzOi8vZ2l0aHViLmNvbS9mbHV0dGVyL3BhY2thZ2VzL3B1bGwvNjM3MyIKCQkJCX0sCgkJCQl7CgkJCQkJImtleSI6ICAidXNlcl9hZ2VudCIsCgkJCQkJInZhbHVlIjogICJmbHV0dGVyLWNvY29vbiIKCQkJCX0KCQkJXSwKCQkJImV4ZSI6ICB7CgkJCQkiY2lwZFBhY2thZ2UiOiAgImZsdXR0ZXIvcmVjaXBlX2J1bmRsZXMvZmx1dHRlci5nb29nbGVzb3VyY2UuY29tL3JlY2lwZXMiLAoJCQkJImNpcGRWZXJzaW9uIjogICJyZWZzL2hlYWRzL21haW4iLAoJCQkJImNtZCI6ICBbCgkJCQkJImx1Y2lleGUiCgkJCQldCgkJCX0sCgkJCSJzY2hlZHVsaW5nVGltZW91dCI6ICAiMjE2MDBzIiwKCQkJImV4ZWN1dGlvblRpbWVvdXQiOiAgIjE4MDBzIiwKCQkJImdyYWNlUGVyaW9kIjogICIzMHMiCgkJfSwKCQkiYnVpbGRMYXJnZUZpZWxkcyI6ICAiZUp4a2swMXYyMFlUeHkwL1R5eDUvQmF0b3FSZ2tjSnVIQ0JRSzVLaVpNbzJVRFJwbXFLSE5MZWdSMkpmaHRUYXkxMTJkNm5VUGZaV29GK2dod0w5VmdYNkZmb2xDbEl2VFZDZWlKM1oyWm4vL3pjLy9iRVB2KzlERE4xQytxeTJpandObml5OHI5eDFGQlhTTDJvV2NsTkd1YXE5Unh0VmxOL1NBaDBjUVpjcnd4aGFzbnU2QThld2F4enBCWHR2V2ExOURRL2dtQXFSV2VTeVFwZnhIOGp1YVFjK0FTaXA4MmcxTFpIY0Q0NjVrcWg5dUs0TzM4R2o4OVdWREhVaE5VYnVIYldsMUFWSlJqR0VzT2ZRTHRHUzgrRFRUWk44WVUwcDYzTGNwb2EwcWx4bGZOTTBET0drcnBTaEl0dTAzZmI2R1BaV2o1QkIwTjlFL3AyTXdEMXVMRHF5Mzk5cHY5UG44QXdPbDJpZE5EckxwVUx5VWZCdzNYTzJHaWhjaDJFSUJ3S1hrbVBtN3lva2U4SC90ZEVJRDZIWENHeXhNZ1NDM251UDdSZW1wTm1OWVk3Y0MvNlh4REg4M1lIRDg0M2dsaUg1cXpQNnN3TlgwSlBhZWFvNWtuSHdXV1hORFhMdk50YU1MY054WlkySU5sa3VFcGpUV25uNHJRTzlTbEdmRzF1U1h6dkJMeDF1dEtkU294M0xraGI0aFREOEZtM2pPYmVoTkJGWHBoYmprdHBiOUpXaUhLUENtRUpoSkpCSnFpZVQ1MjVCazR2ME9yM0NaSDU1eGEveXFVZ3VlVXJqZkRKbHlVV2NKanlaeFlqeitUeGhPTWt2TUJXekNXT3o5REptNlJRcHBtd2F6K0FaSEtGZVprdHFKV1VLSFhrMEdzSUF1aSsvZmZIbXphdlhEVk1yaWVGek9QRFVGdWhYSGp3T1BuNkhMR08xVkNLalNtMU5EdTlvcWVBTWV1ZTMwdk1GYWpJY0RhQVBCMWpXaW5yTUNvNHRqZzhBR2xPWXBab3ZHcXRLS2pXY3JuYkJZazZHd2NCaTdxS3FWaXBLcC9OcHRFQXFHdmFabGJxb3E1YW5QaHdVUm9uTTI3c2J3OXJLYitGUVlJVmFvT1lTSFhtVnZJUVhveS9oREdCN2Z0ZmcxOUtMR2RVaUUxWXUwVUlBM1RWTDVDUTRXdjllVHlhek1JWSs5Q3pERDJCNS9aK1ZrYzQwVXdveUdVVXczcTdNaytCc3N6THJqRlhnZzQwWlFKY3ZxTmFvM3RQOWV6amE0dGpBU3I0WmZRMWZiUXRmQnVrR3ZVbUlXbFJHYXUvQ3ZPWUxKK2xZNnR6U2NYT3ZUUWxic3NLR0puZ0s5L0ZIekxpc1JMYVp1UitjdEpJM1FydW9NZVRuenM0L0FRQUEvLzhESUd6OCIKCX0sCgkidXNlckRhdGEiOiAgImV5SmlkV2xzWkdWeVgyNWhiV1VpT2lKTWFXNTFlRjkzWldJZ2QyVmlYMkoxYVd4a1gyRnNiRjl3WVdOcllXZGxjeUJ0WVhOMFpYSWlMQ0pqYUdWamExOXlkVzVmYVdRaU9qSXpNREExTnpNek16ZzBMQ0pqYjIxdGFYUmZjMmhoSWpvaU1qY3lZekEyT0RNeU16VmhZemhqTjJVNU0yUXhNbU5oWmpObU5qUmlOMlUxWVRCaU5XTXpNaUlzSW1OdmJXMXBkRjlpY21GdVkyZ2lPaUp0WVdsdUlpd2ljbVZ3YjE5dmQyNWxjaUk2SW1ac2RYUjBaWElpTENKeVpYQnZYMjVoYldVaU9pSndZV05yWVdkbGN5SXNJblZ6WlhKZllXZGxiblFpT2lKbWJIVjBkR1Z5TFdOdlkyOXZiaUo5Igp9","messageId":"10771934691919436","message_id":"10771934691919436","publishTime":"2024-03-24T14:38:05.338Z","publish_time":"2024-03-24T14:38:05.338Z"},"subscription":"projects/flutter-dashboard/subscriptions/build-bucket-presubmit-sub"}
''';

    final PubSubPushMessageV2 pushMessageV2 = PubSubPushMessageV2.fromJson(json.decode(message));

    final PubSubPushMessageV2 pushMessageV2_2 = PubSubPushMessageV2.fromJson(json.decode(message_2));
    print(pushMessageV2_2.message!.data!);

    final bbv2.PubSubCallBack pubSubCallBack = bbv2.PubSubCallBack();
    Map<String, dynamic> mapJson = jsonDecode(pushMessageV2_2.message!.data!) as Map<String, dynamic>;

    // print(mapJson);

    pubSubCallBack.mergeFromProto3Json(jsonDecode(pushMessageV2_2.message!.data!) as Map<String, dynamic>);
    final List<int> uD = pubSubCallBack.userData;
    String dt = String.fromCharCodes(pubSubCallBack.userData);
    print(dt);

    // String userDataString = String.fromCharCodes(pubSubCallBack.userData);

    // final bbv2.BuildsV2PubSub buildsV2PubSub = bbv2.BuildsV2PubSub.create();
    // buildsV2PubSub.mergeFromProto3Json(json.decode(pushMessageV2_2.message!.data!));

    // print(pubSubCallBack.hasUserData());

    // pubSubCallBack.mergeFromProto3Json(jsonDecode(message) as Map<String, dynamic>);
    // print('...');
    // print(String.fromCharCodes(base64Decode(String.fromCharCodes(pubSubCallBack.userData))));
    // print('...');

    // print(String.fromCharCodes((base64.decode(pushMessageV2.message!.data!))));

    // print(pushMessageV2.message!.data!.toString());

    // final String unencodedData = String.fromCharCodes((base64.decode(pushMessageV2_2.message!.data!)));
    // print(unencodedData);
    // final bbv2.BatchRequest batchRequest = bbv2.BatchRequest.create();

    // batchRequest.mergeFromProto3Json(jsonDecode(pushMessageV2.message!.data!));

    // print(jsonEncode(batchRequest.toProto3Json()));

    // expect(batchRequest.requests.length, 5);
    // Absolutely need this Encode call before sending over https to prpc.
    // print(jsonEncode(batchRequest.toProto3Json()));
  });

  test('schedules request to buildbucket', () async {
    final bbv2.BuilderID responseBuilderID = bbv2.BuilderID();
    responseBuilderID.builder = 'Linux A';

    final bbv2.Build responseBuild = bbv2.Build();
    responseBuild.id = Int64(12345);
    responseBuild.builder = responseBuilderID;

    // has a list of BatchResponse_Response
    final bbv2.BatchResponse batchResponse = bbv2.BatchResponse();
    final bbv2.BatchResponse_Response batchResponseResponse = bbv2.BatchResponse_Response();
    batchResponseResponse.scheduleBuild = responseBuild;
    batchResponse.responses.add(batchResponseResponse);

    when(buildBucketV2Client.batch(any)).thenAnswer((_) async => batchResponse);

    // We cannot construct the object manually with the protos as we cannot write out
    // the json with all the required double quotes and testing fails.
    const String messageData = '''
{
  "requests": [
    {
      "scheduleBuild": {
        "builder": {
          "builder": "Linux A"
        }
      }
    }
  ]
}
''';

    const PushMessageV2 pushMessageV2 = PushMessageV2(data: messageData, messageId: '798274983');
    tester.message = pushMessageV2;
    final Body body = await tester.post(handler);
    expect(body, Body.empty);
  });

  test('retries schedule build if no response comes back', () async {
    final bbv2.BuilderID responseBuilderID = bbv2.BuilderID();
    responseBuilderID.builder = 'Linux A';

    final bbv2.Build responseBuild = bbv2.Build();
    responseBuild.id = Int64(12345);
    responseBuild.builder = responseBuilderID;

    // has a list of BatchResponse_Response
    final bbv2.BatchResponse batchResponse = bbv2.BatchResponse();

    final bbv2.BatchResponse_Response batchResponseResponse = bbv2.BatchResponse_Response();
    batchResponseResponse.scheduleBuild = responseBuild;

    batchResponse.responses.add(batchResponseResponse);

    int attempt = 0;

    when(buildBucketV2Client.batch(any)).thenAnswer((_) async {
      attempt += 1;
      if (attempt == 2) {
        return batchResponse;
      }

      return bbv2.BatchResponse().createEmptyInstance();
    });

    const String messageData = '''
{
  "requests": [
    {
      "scheduleBuild": {
        "builder": {
          "builder": "Linux A"
        }
      }
    }
  ]
}
''';

    const PushMessageV2 pushMessageV2 = PushMessageV2(data: messageData, messageId: '798274983');
    tester.message = pushMessageV2;
    final Body body = await tester.post(handler);

    expect(body, Body.empty);
    expect(verify(buildBucketV2Client.batch(any)).callCount, 2);
  });

  test('acking message and logging error when no response comes back after retry limit', () async {
    when(buildBucketV2Client.batch(any)).thenAnswer((_) async {
      return bbv2.BatchResponse().createEmptyInstance();
    });

    const String messageData = '''
{
  "requests": [
    {
      "scheduleBuild": {
        "builder": {
          "builder": "Linux A"
        }
      }
    }
  ]
}
''';

    const PushMessageV2 pushMessageV2 = PushMessageV2(data: messageData, messageId: '798274983');
    tester.message = pushMessageV2;
    final Body body = await tester.post(handler);

    expect(body, isNotNull);
    expect(verify(buildBucketV2Client.batch(any)).callCount, 3);
  });
}
